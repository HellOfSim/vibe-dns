# =============================================================================
# 1. LOGGING
# found in: utils.py, defaults.py
# =============================================================================
logging:
  # Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "INFO"
  
  # Print logs to stdout (terminal)
  enable_console: true
  
  # Include timestamp in console logs (set false if using systemd/docker)
  console_timestamp: true
  
  # Write logs to a file
  enable_file: false
  file_path: "./dns_server.log"
  
  # Send logs to local Syslog or remote Syslog server
  enable_syslog: false
  # Can be a file path (e.g., /dev/log) or "host:port" (e.g., 192.168.1.50:514)
  syslog_address: "/dev/log"
  # Protocol if sending over network: UDP or TCP
  syslog_protocol: "UDP"

# =============================================================================
# 2. SERVER NETWORKING
# found in: server.py, resolver.py
# =============================================================================
server:
  # List of IPs to listen on. Use "0.0.0.0" for all IPv4, "::" for all IPv6.
  bind_ip: 
    - "0.0.0.0"
    - "::"
  
  # OPTIONAL: Bind by interface name (requires 'netifaces' module or 'ip' command). 
  # These are resolved to IPs at startup and added to bind_ip.
  # bind_interfaces: 
  #   - "eth0"
  #   - "wg0"
  
  # Ports to listen on (List of integers). Standard is 53.
  port_udp: [53, 5353, 53053]
  port_tcp: [53, 5353, 53053]
  
  # --- EDNS Client Subnet (ECS) Handling ---
  # Enable parsing of ECS data from incoming clients
  use_ecs: true
  
  # How to handle ECS when forwarding to upstream:
  # - none:     Strip ECS data (Default/Privacy)
  # - preserve: Forward client's provided ECS data if present
  # - add:      Inject the client's actual IP as ECS data
  # - privacy:  Truncate client IP to mask (defined below) before forwarding
  # - override: Force a specific IP (defined below) to be sent as ECS
  forward_ecs_mode: "none"

  # ECS Masks for 'privacy' mode (Subnet bits to keep)
  ecs_ipv4_mask: 24
  ecs_ipv6_mask: 56

  # ECS Overrides for 'override' mode (Simulate request from this IP)
  # ecs_override_ipv4: "1.2.3.4"
  # ecs_override_ipv6: "2001:db8::1"

  # --- MAC Address Handling ---
  # Enable parsing of custom EDNS MAC option (Code 65001)
  use_edns_mac: true
  
  # How to handle MAC forwarding to upstream:
  # - none:     Do not send MAC to upstream
  # - preserve: Forward existing MAC option if present
  # - add:      Resolve client MAC from ARP table and inject it via EDNS
  forward_mac_mode: "none"

# =============================================================================
# 3. GEOIP CONFIGURATION
# found in: geoip.py
# =============================================================================
geoip:
  enabled: true
  
  # Path to unified .vibe database (compiled by geoip_compiler.py)
  unified_database: "./geoip.vibe"
  
  # ccTLD Resolution Mode:
  # - geoip_first: Trust IP-based GeoIP, fall back to ccTLD
  # - cctld_first: Trust ccTLD, fall back to GeoIP
  # - geoip_only:  Only use IP-based GeoIP
  # - cctld_only:  Only use ccTLD
  cctld_mode: "geoip_first"

# =============================================================================
# 4. UPSTREAM RESOLVERS
# found in: upstream_manager.py
# =============================================================================
upstream:
  # Selection mode: "fastest", "loadbalance", "failover", "random", "sticky", "none"
  mode: "fastest"
  
  # Monitoring options
  monitor_interval: 30
  monitor_on_query: false
  
  # Circuit breaker settings
  circuit_breaker_enabled: true
  circuit_failure_threshold: 3
  circuit_recovery_timeout: 60
  
  # Startup health check
  startup_check_enabled: true
  startup_check_timeout: 5
  max_startup_retries: 3
  
  # Bootstrap servers (used if all configured servers fail)
  fallback_enabled: true
  bootstrappers:
    - { ip: "86.54.11.1", port: 53 }
    - { ip: "9.9.9.9", port: 53 }
  
  # Upstream server groups
  groups:
    Default:
      servers:
        - "udp://1.1.1.1:53"
        - "udp://8.8.8.8:53"
        - "udp://9.9.9.9:53"
    
    Secure:
      servers:
        - "https://dns.google:443/dns-query"
        - "https://cloudflare-dns.com:443/dns-query"
        - "tls://1.1.1.1:853"
    
    Adguard:
      servers:
        - "https://dns.adguard-dns.com:443/dns-query"
        - "tls://dns.adguard-dns.com:853"

# =============================================================================
# 5. CACHE CONFIGURATION
# found in: resolver.py, cache.py
# =============================================================================
cache:
  enabled: true
  max_size: 10000
  max_ttl: 86400
  min_ttl: 30
  
  # Prefetch settings
  prefetch_enabled: true
  prefetch_threshold: 0.2
  prefetch_min_hits: 3
  
  # Stale serving
  serve_stale: true
  stale_ttl: 3600

# =============================================================================
# 6. DECISION CACHE
# found in: decision_cache.py
# =============================================================================
decision_cache:
  enabled: true
  max_size: 50000
  default_ttl: 300

# =============================================================================
# 7. DEDUPLICATION & RATE LIMITING
# found in: deduplication.py, rate_limiter.py
# =============================================================================
deduplication:
  enabled: true
  timeout: 2.0
  max_size: 5000

rate_limit:
  enabled: true
  # Limits per IP (requests per second)
  requests_per_second: 50
  burst_size: 100
  # Action when limit exceeded: "DROP", "TC" (truncate response)
  action: "TC"

# =============================================================================
# 8. RESPONSE SHAPING
# found in: resolver.py
# =============================================================================
response:
  # Round-robin answers on each query
  round_robin_answers: true
  
  # Clamp TTL values
  clamp_ttl_min: 30
  clamp_ttl_max: 86400
  
  # Inject blocking IP for blocked domains
  # Options: "NULL" (0.0.0.0/::), IP address, or false
  block_ip: "NULL"
  
  # RCODE to return for blocked domains
  # Options: "NXDOMAIN", "REFUSED", "SERVFAIL"
  block_rcode: "NXDOMAIN"
  
  # IP blocking mode for answer filtering
  # - "block": Return NXDOMAIN/REFUSED
  # - "filter": Remove specific IPs from answer, return rest
  ip_block_mode: "filter"
  
  # Apply blocklists/GeoIP rules to IPs found inside the answer section recursively.
  match_answers_globally: false

# =============================================================================
# 9. CATEGORIZATION
# found in: filtering.py
# =============================================================================
categorization_enabled: true
categories_file: "categories.json"

# =============================================================================
# 10. CLIENT GROUPS
# found in: server.py, resolver.py
# =============================================================================
# How often to refresh ARP/Neigh tables for MAC resolution (Seconds)
mac_cache_refresh_interval: 300

# Group definitions
# Identifiers can be:
# - IP Address (192.168.1.5)
# - CIDR Subnet (192.168.1.0/24)
# - MAC Address (aa:bb:cc:dd:ee:ff)
# - GeoIP Tag (geoip:US, geoip:EUROPE) - Matches based on Source IP location
# - Server Bind IP (server_ip:10.0.0.1) - useful for VLAN gateways listening on specific IPs
# - Server Port (server_port:5353) - useful for specific listeners
groups:
  admin_devices:
    - "10.0.0.5"
    - "AA:BB:CC:DD:EE:FF"
  
  iot_vlan:
    # OPTIONAL: Set a default action for this group (ALLOW, BLOCK, DROP)
    # If set, this overrides policies for unhandled domains, effectively acting as a whitelist mode if set to BLOCK.
    - { default_action: "ALLOW" }
    - "10.0.50.0/24"
    - "server_ip:10.0.50.1"
  
  kids:
    - "10.0.0.10"
    - "geoip:NL" # Example: Apply 'kids' policy to anyone connecting from Netherlands IP
    
  vpn_users:
    - "server_ip:10.8.0.1"

# Load groups from external text files (one identifier per line)
# These files are auto-reloaded based on refresh_interval.
group_files:
  refresh_interval: 300
  kids: "./groups/kids.txt"

# =============================================================================
# 11. SCHEDULES
# found in: resolver.py
# =============================================================================
schedules:
  bedtime:
    - { days: ["Mon", "Tue", "Wed", "Thu", "Sun"], start: "21:00", end: "07:00" }
    - { days: ["Fri", "Sat"], start: "23:00", end: "08:00" }

  work_hours:
    - { days: ["Mon", "Tue", "Wed", "Thu", "Fri"], start: "09:00", end: "17:00" }

# =============================================================================
# 12. FILTER LISTS
# found in: list_manager.py
# =============================================================================
# Auto-refresh interval for downloading lists (seconds)
list_refresh_interval: 86400

lists:
  # Remote HTTP source
  ad_servers:
    - source: "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"
      # Parsing mode:
      # - exact:     Matches domain exactly
      # - inclusive: Matches domain and all subdomains (example.com matches sub.example.com)
      # - exclusive: Matches only subdomains (*.example.com)
      hosts_domain_type: "inclusive"
  
  # Local file source
  my_whitelist:
    - source: "./lists/whitelist.txt"
      hosts_domain_type: "exact"
  
  # GeoIP blocking list (v10.0: Now supports ALLOW for all rule types)
  # Syntax: 
  #   @@TAG = Query (ccTLD) AND Answer (IP) - Supports ALLOW, BLOCK, DROP
  #   @TAG  = Query (ccTLD) only - Supports ALLOW, BLOCK, DROP
  #   @AS#  = Answer (ASN) only - Supports ALLOW, BLOCK, DROP (NEW in v10.0!)
  geo_block:
    - source: "./lists/geo_block.txt"
  
  # NEW in v10.0: Allowlist examples
  trusted_cdns:
    - source: "./lists/trusted_cdns.txt"
      # Contains: @AS13335 (Cloudflare), @AS15169 (Google), @AS16509 (AWS)
  
  trusted_countries:
    - source: "./lists/trusted_countries.txt"
      # Contains: @@US, @@CA, @@EU, @@WESTERN_EUROPE

# =============================================================================
# 13. POLICIES
# found in: filtering.py, resolver.py
# =============================================================================
policies:
  # Default policy if no group matches (Implicit)
  Default:
    upstream_group: "Default"
  
  # Strict policy for Kids (v10.0: Enhanced with ALLOW support)
  KidsPolicy:
    upstream_group: "Secure"
    
    # v10.0: ALLOW lists now support ASN and GeoIP rules!
    allow: ["my_whitelist", "trusted_cdns"]
    
    # BLOCK lists (checked after ALLOW)
    block: ["ad_servers", "geo_block"]
    
    # Silent drop (no response) - good for telemetry/tracking
    drop: []
    
    # Query Type Filtering
    allowed_types: ["A", "AAAA", "CNAME", "HTTPS"] # If set, only these are allowed
    blocked_types: ["TXT", "ANY"] # Returns Block RCODE
    dropped_types: []             # Returns nothing (timeout)
    
    # Category-based rules (requires categorization_enabled)
    # actions: ALLOW, BLOCK, DROP
    category_rules:
      gambling:
        min_confidence: 85  # Only block if confidence > 85%
        action: "BLOCK"
      adult:
        min_confidence: 60
        action: "BLOCK"
      social_media:
        min_confidence: 90
        action: "DROP"

  # Example of an "Allow-List Only" policy (Walled Garden)
  IoTPolicy:
    upstream_group: "Default"
    allow: ["my_whitelist"]
    # Note: To make this strictly whitelist-only, set the Group's 'default_action' to BLOCK
    # or ensure a 'block all' list is applied here.
  
  # NEW in v10.0: Geo-fencing example
  RegionalPolicy:
    upstream_group: "Default"
    # Only allow specific countries (requires group default_action: BLOCK)
    allow: ["trusted_countries"]
    block: ["geo_block"]
  
  # NEW in v10.0: CDN allowlist example
  EnterprisePolicy:
    upstream_group: "Corporate"
    # Allow trusted CDNs even if from blocked countries
    allow: ["trusted_cdns", "trusted_countries", "my_whitelist"]
    block: ["ad_servers", "geo_block"]

# =============================================================================
# 14. ASSIGNMENTS
# found in: resolver.py
# =============================================================================
assignments:
  # Group Name matches keys in 'groups' section
  kids:
    policy: "KidsPolicy"
    schedule: "bedtime"
    # Policy to apply when schedule is ACTIVE (Built-in policies: BLOCK, ALLOW, DROP)
    # Can also be a custom policy name
    schedule_policy: "BLOCK" 
    
  iot_vlan:
    policy: "IoTPolicy"
    
  admin_devices:
    policy: "Default"
